<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSP Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #f9f9f9;
        }
        .container {
            background: white;
            padding: 2rem 4rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        h1, h2, h3 { color: #111; margin-top: 1.5em; }
        h1 { border-bottom: 2px solid #eaeaea; padding-bottom: 0.3em; }
        h2 { border-bottom: 1px solid #eaeaea; padding-bottom: 0.3em; }
        a { color: #0366d6; text-decoration: none; }
        a:hover { text-decoration: underline; }
        code {
            background-color: #f6f8fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 85%;
        }
        pre {
            background-color: #f6f8fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }
        pre code {
            padding: 0;
            background-color: transparent;
            font-size: 100%;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }
        th, td {
            border: 1px solid #dfe2e5;
            padding: 0.6rem 1rem;
        }
        th { background-color: #f6f8fa; font-weight: 600; }
        tr:nth-child(2n) { background-color: #fcfcfc; }
        blockquote {
            border-left: 4px solid #dfe2e5;
            color: #6a737d;
            margin: 0;
            padding-left: 1rem;
        }
        .nav-back {
            display: inline-block;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        /* Mermaid styling */
        .mermaid {
            display: flex;
            justify-content: center;
            background: white;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <a href="index.html" class="nav-back">‚Üê Back to Index</a>
    <div id="content" class="container">Loading...</div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });

        async function loadContent() {
            const params = new URLSearchParams(window.location.search);
            const file = params.get('file');
            
            if (!file) {
                document.getElementById('content').innerHTML = '<h1>Error</h1><p>No file specified.</p>';
                return;
            }

            try {
                const response = await fetch(file);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();
                
                // Configure marked to handle mermaid code blocks differently
                const renderer = new marked.Renderer();
                const originalCode = renderer.code.bind(renderer);
                
                renderer.code = function(code, language) {
                    if (language === 'mermaid') {
                        return `<div class="mermaid">${code}</div>`;
                    }
                    return originalCode(code, language); 
                };

                // Intercept links to point to viewer
                const originalLink = renderer.link.bind(renderer);
                renderer.link = function(href, title, text) {
                    if (href.endsWith('.md')) {
                        return `<a href="viewer.html?file=${href}" title="${title || ''}">${text}</a>`;
                    }
                    return originalLink(href, title, text);
                };

                marked.setOptions({ renderer });
                
                document.getElementById('content').innerHTML = marked.parse(text);
                document.title = file.split('/').pop().replace('.md', '') + ' - BSP Docs';

                // Render diagrams
                await mermaid.run({
                    nodes: document.querySelectorAll('.mermaid')
                });

            } catch (error) {
                document.getElementById('content').innerHTML = `<h1>Error</h1><p>Failed to load ${file}: ${error.message}</p>`;
            }
        }

        loadContent();
    </script>
</body>
</html>
